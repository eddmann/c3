name: Test

on:
  push:
    branches: ['**']
  pull_request:
  workflow_dispatch:
  workflow_call:

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang clang-tidy clang-format

      - name: Configure
        run: |
          cmake --preset lint \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++

      - name: Lint (clang-tidy)
        run: cmake --build --preset lint

      - name: Check formatting
        run: |
          find src include -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror

  build-and-test:
    name: ${{ matrix.os }} / ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            arch: x64
            cc: clang
            cxx: clang++
          - os: linux
            runner: ubuntu-latest
            arch: arm64
          - os: macos
            runner: macos-15-intel
            arch: x64
            cc: /usr/bin/clang
            cxx: /usr/bin/clang++
          - os: macos
            runner: macos-latest
            arch: arm64
            cc: /usr/bin/clang
            cxx: /usr/bin/clang++
          - os: windows
            runner: windows-latest
            arch: x64
            cc: 'C:/Program Files/LLVM/bin/clang-cl.exe'
            cxx: 'C:/Program Files/LLVM/bin/clang-cl.exe'
            ninja_path: 'C:/ProgramData/chocolatey/bin/ninja.exe'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Linux x86)
        if: matrix.os == 'linux' && matrix.arch == 'x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang

      - name: Install dependencies (Linux arm64)
        if: matrix.os == 'linux' && matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build \
            qemu-user-static gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libc6-arm64-cross libstdc++-13-dev-arm64-cross

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew update
          brew install ninja

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          choco install llvm ninja --no-progress

      - name: Configure (Debug)
        if: matrix.cc
        shell: bash
        run: |
          cmake --preset debug \
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" \
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" \
            ${{ matrix.ninja_path && format('-DCMAKE_MAKE_PROGRAM="{0}"', matrix.ninja_path) || '' }}

      - name: Configure (Debug, cross-compile arm64)
        if: matrix.os == 'linux' && matrix.arch == 'arm64'
        run: |
          cmake --preset debug \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_CROSSCOMPILING_EMULATOR="qemu-aarch64-static;-L;/usr/aarch64-linux-gnu" \
            -DC3_ENABLE_ASAN=OFF \
            -DC3_ENABLE_UBSAN=OFF

      - name: Build (Debug)
        run: cmake --build --preset debug

      - name: Test
        run: ctest --preset tests
