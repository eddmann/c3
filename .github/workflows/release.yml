name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3)'
        required: true

permissions:
  contents: write

jobs:
  tests:
    uses: ./.github/workflows/test.yml

  build-release:
    name: Build ${{ matrix.os }} / ${{ matrix.arch }}
    needs: tests
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            arch: x64
            cc: clang
            cxx: clang++
            linker_flags: '-fuse-ld=lld'
          - os: linux
            runner: ubuntu-latest
            arch: arm64
          - os: macos
            runner: macos-15-intel
            arch: x64
            cc: /usr/bin/clang
            cxx: /usr/bin/clang++
          - os: macos
            runner: macos-latest
            arch: arm64
            cc: /usr/bin/clang
            cxx: /usr/bin/clang++
          - os: windows
            runner: windows-latest
            arch: x64
            cc: 'C:/Program Files/LLVM/bin/clang-cl.exe'
            cxx: 'C:/Program Files/LLVM/bin/clang-cl.exe'
            ninja_path: 'C:/ProgramData/chocolatey/bin/ninja.exe'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Linux x86)
        if: matrix.os == 'linux' && matrix.arch == 'x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang lld

      - name: Install dependencies (Linux arm64)
        if: matrix.os == 'linux' && matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libc6-arm64-cross libstdc++-13-dev-arm64-cross

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew update
          brew install ninja

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          choco install llvm ninja --no-progress

      - name: Configure (Release)
        if: matrix.cc
        shell: bash
        run: |
          cmake --preset release \
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" \
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" \
            ${{ matrix.ninja_path && format('-DCMAKE_MAKE_PROGRAM="{0}"', matrix.ninja_path) || '' }} \
            ${{ matrix.linker_flags && format('-DCMAKE_EXE_LINKER_FLAGS="{0}"', matrix.linker_flags) || '' }}

      - name: Configure (Release, cross-compile arm64)
        if: matrix.os == 'linux' && matrix.arch == 'arm64'
        run: |
          cmake --preset release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++

      - name: Build (Release)
        run: cmake --build --preset release

      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            cp build-release/c3.exe "dist/c3-${{ matrix.os }}-${{ matrix.arch }}.exe"
          else
            cp build-release/c3 "dist/c3-${{ matrix.os }}-${{ matrix.arch }}"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: c3-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/c3-*

  publish-release:
    name: Publish ${{ inputs.version }}
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: dist
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
