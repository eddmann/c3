name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3)'
        required: true

permissions:
  contents: write

jobs:
  tests:
    uses: ./.github/workflows/test.yml

  build-release:
    name: Build ${{ matrix.os }} / ${{ matrix.arch }}
    needs: tests
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            arch: x64
            cc: clang
            cxx: clang++
            clang_tools_bin: ''
          - os: linux
            runner: ubuntu-latest
            arch: arm64
            cross: true
          - os: macos
            runner: macos-13
            arch: x64
            cc: clang
            cxx: clang++
            clang_tools_bin: /usr/local/opt/llvm/bin
          - os: macos
            runner: macos-14
            arch: arm64
            cc: clang
            cxx: clang++
            clang_tools_bin: /opt/homebrew/opt/llvm/bin
          - os: windows
            runner: windows-latest
            arch: x64
            cc: clang-cl
            cxx: clang-cl
            clang_tools_bin: 'C:/Program Files/LLVM/bin'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Linux)
        if: matrix.os == 'linux' && !matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build clang

      - name: Install dependencies (Linux ARM64 cross)
        if: matrix.os == 'linux' && matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libc6-arm64-cross libstdc++-13-dev-arm64-cross

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew update
          brew install ninja llvm

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          choco install llvm ninja --no-progress

      - name: Add clang tools to PATH
        if: matrix.clang_tools_bin != ''
        shell: bash
        run: echo "PATH=${{ matrix.clang_tools_bin }}:${PATH}" >> $GITHUB_ENV

      - name: Configure (Release)
        if: ${{ !matrix.cross }}
        run: |
          cmake --preset release \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}

      - name: Configure (Release, cross-compile ARM64)
        if: matrix.cross
        run: |
          cmake --preset release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++

      - name: Build (Release)
        run: cmake --build --preset release

      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            cp build-release/c3.exe "dist/c3-${{ matrix.os }}-${{ matrix.arch }}.exe"
          else
            cp build-release/c3 "dist/c3-${{ matrix.os }}-${{ matrix.arch }}"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: c3-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/c3-*

  publish-release:
    name: Publish ${{ inputs.version }}
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: dist
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
